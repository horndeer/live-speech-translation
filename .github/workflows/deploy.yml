name: Deploy to Google Cloud

on:
  push:
    branches:
      - main

# Prérequis sur le serveur : Node.js + npm (pour Tailwind), Python + venv, pm2.
# Voir README-TAILWIND.md et la section Déploiement ci‑dessous.
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 22
          command_timeout: 15m
          script: |
            set -e
            cd ~/live-speech-translation

            git pull origin main

            # Tailwind CSS : npm ci + build → génère static/css/tailwind.css
            npm ci
            npm run build-css

            # Python + app
            source venv/bin/activate
            pip install -r requirements.txt

            pm2 reload traduction-app || pm2 restart traduction-app