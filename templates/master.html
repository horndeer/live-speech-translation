<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master - Traduction Live</title>
    
    <!-- Tailwind CSS g√©n√©r√© (remplace le CDN) -->
    <link href="{{ url_for('static', path='css/tailwind.css') }}" rel="stylesheet">

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script src="{{ url_for('static', path='js/vendor/socket.io.js') }}"></script>
    <script src="{{ url_for('static', path='js/message-manager-v0.2.js') }}"></script>
    <script src="{{ url_for('static', path='js/vendor/azure-speech-sdk/microsoft.cognitiveservices.speech.sdk.bundle-min.js') }}"></script>
</head>

<body class="bg-background text-zinc-100 h-screen w-screen overflow-hidden flex font-sans">

    <div id="sidebar" class="fixed inset-y-0 left-0 w-80 bg-surface border-r border-zinc-800 transform -translate-x-full transition-transform duration-300 ease-in-out z-50 flex flex-col shadow-2xl">
        
        <div class="p-4 border-b border-zinc-700 flex justify-between items-center">
            <h2 class="text-lg font-semibold text-zinc-300">Historique</h2>
            <button onclick="toggleSidebar()" class="p-2 hover:bg-zinc-700 rounded-full text-zinc-400">
                <i class="ph ph-x text-xl"></i>
            </button>
        </div>

        <div class="p-4">
            <a href="/master/new" class="w-full py-3 px-4 bg-zinc-800 hover:bg-zinc-700 text-zinc-200 rounded-full flex items-center gap-3 transition-colors border border-zinc-700">
                <i class="ph ph-plus text-primary"></i>
                <span>Nouvelle conversation</span>
            </a>
        </div>

        <div class="flex-1 overflow-y-auto p-2 space-y-1" id="history-list">
            {% for conv in convs_list %}
                <a href="master/conv/{{ conv.id }}" class="block w-full text-left p-3 hover:bg-zinc-800 rounded-lg text-sm text-zinc-400 truncate transition-colors">
                    {{ conv.title }}
                </a>
            {% endfor %}
        </div>        
    </div>

    <div class="flex-1 flex flex-col h-full relative">
        
        <div id="container-scroll" class="flex-1 overflow-y-auto pb-32 px-4 md:px-12 lg:px-32 scroll-smooth">
            <div id="conversation" class="flex flex-col justify-end min-h-full py-6 ">
                
                </div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 h-24 glass-panel border-t border-zinc-800 flex items-center justify-between px-6 md:px-12 z-30">
            
            <div class="flex items-center gap-4 w-1/3">
                <button onclick="toggleSidebar()" class="p-3 hover:bg-zinc-800 rounded-full text-zinc-400 hover:text-white transition-all group" title="Historique">
                    <i class="ph ph-list text-2xl group-hover:scale-110 transition-transform"></i>
                </button>
                
                <a href="/master/new" class="hidden md:flex items-center gap-2 px-4 py-2 bg-zinc-800 hover:bg-zinc-700 rounded-full text-sm text-zinc-300 transition-colors border border-zinc-700/50">
                    <i class="ph ph-plus"></i>
                    <span>Nouveau</span>
                </a>
                {% if DEV_MODE %}
                <button id="btnDevFlood" onclick="runDevTranslationFlood()" class="p-2 rounded-full text-zinc-500 hover:text-amber-500 hover:bg-zinc-800 border border-zinc-700/50 text-xs" title="Simuler un flux de traductions (remplir la page)">Dev</button>
                {% endif %}
            </div>

            <div class="flex items-center justify-center gap-6 w-1/3">
                <button id="btnStart" onclick="startRecognition()" class="w-16 h-16 rounded-full bg-primary hover:bg-[#02b0eb] text-black flex items-center justify-center shadow-[0_0_20px_rgba(0,191,255,0.3)] hover:shadow-[0_0_30px_rgba(0,191,255,0.5)] hover:scale-105 transition-all disabled:opacity-20 disabled:cursor-not-allowed disabled:shadow-none">
                    <i class="ph-fill ph-microphone text-3xl"></i>
                </button>
                
                <button id="btnStop" onclick="stopRecognition()" disabled class="w-12 h-12 rounded-full bg-zinc-800 hover:bg-red-500/20 hover:text-red-500 text-zinc-400 border border-zinc-700 flex items-center justify-center transition-all disabled:opacity-20 disabled:cursor-not-allowed">
                    <i class="ph-fill ph-pause text-xl"></i>
                </button>
            </div>

            <div class="flex items-center justify-end gap-3 w-1/3">
                <div class="flex items-center gap-2 px-3 py-1.5 bg-zinc-900 rounded-full border border-zinc-800">
                    <span class="relative flex h-2.5 w-2.5">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-red-500"></span>
                    </span>
                    <span id="viewer-count" class="text-sm font-mono text-zinc-300">34</span>
                    <i class="ph ph-users text-zinc-500 text-lg ml-1"></i>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- LOGIQUE UI ---

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            
            // On bascule la classe translate-x-full
            if (sidebar.classList.contains('-translate-x-full')) {
                // Ouvrir
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
                // Petit d√©lai pour l'opacit√© (transition fade-in)
                setTimeout(() => overlay.classList.remove('opacity-0'), 10);
            } else {
                // Fermer
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        // Fonction pour formater l'heure
        function getCurrentTime() {
            const now = new Date();
            return now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
        }

    </script>

    <script>

        const DEV_MODE = "{{ DEV_MODE|tojson }}";
        const socket = io();

        // UI Manager
        const ui = new MessageManager(socket, DEV_MODE);

        socket.on("update_viewer_count", (count) => {
            document.getElementById('viewer-count').textContent = count;
        });
        
        async function getTokenOrRefresh() {
            try {
                const response = await fetch('/api/get-token');
                
                const data = await response.json();
        
                if (!response.ok) {
                    const errorMessage = data.error || "Erreur inconnue lors de la r√©cup√©ration du token";
                    throw new Error(errorMessage);
                }   
        
                return {
                    token: data.token,
                    region: data.region
                };
        
            } catch (error) {
                if (DEV_MODE) console.error("Erreur Critique Authentication:", error.message);
                alert("Impossible de se connecter au service vocal");
                return null;
            }
        }

        // sdk azure
        let recognizer = null;

        // --- Configuration Azure ---
        async function startRecognition() {

            const authdata = await getTokenOrRefresh();
            if (!authdata) return;

            const { token, region } = authdata;
            console.log('authentification r√©ussie pour la r√©gion : ' + region);

            // 1. Config de base
            const speechConfig = SpeechSDK.SpeechTranslationConfig.fromAuthorizationToken(token, region);

            // 2. Cibles (Ce que vous voulez obtenir)
            speechConfig.addTargetLanguage("fr");
            speechConfig.addTargetLanguage("es");

            // --- L'ASTUCE EST ICI ---

            speechConfig.speechRecognitionLanguage = "fr-FR";

            speechConfig.setProperty(
                SpeechSDK.PropertyId.SpeechServiceConnection_AutoDetectSourceLanguages,
                "fr-FR,es-MX" // Liste des candidats possibles
            );

            const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();

            try {
                recognizer = new SpeechSDK.TranslationRecognizer(speechConfig, audioConfig);

                // 1. En cours de parole (Interim)
                recognizer.recognizing = (s, e) => {

                    if (DEV_MODE) console.log("reconnaissance en cours de parole...");

                    const data = {
                        lang: e.result.language,
                        fr: (e.result.language.includes("fr") ? e.result.text : e.result.translations.get("fr")),
                        es: (e.result.language.includes("es") ? e.result.text : e.result.translations.get("es")),
                        is_final: false,
                    };
                    if (DEV_MODE) console.log("emiting temp data:", data);
                    socket.emit('new_translation', data);
                    ui.addMessage(data);
                };

                // 2. Phrase termin√©e (Final)
                recognizer.recognized = (s, e) => {
                    if (e.result.reason == SpeechSDK.ResultReason.TranslatedSpeech) {
                        if (DEV_MODE) console.log("phrase termin√©e re√ßus:");
                        const data = {
                            lang: e.result.language,
                            fr: (e.result.language.includes("fr") ? e.result.text : e.result.translations.get("fr")),
                            es: (e.result.language.includes("es") ? e.result.text : e.result.translations.get("es")),
                            timestamp: new Date().toISOString(),
                            is_final: true,
                        };
                        if (DEV_MODE) console.log("emiting final data:", data);
                        socket.emit('new_translation', data);
                        ui.addMessage(data);
                    }
                };

                recognizer.canceled = (s, e) => {
                    if (DEV_MODE) console.error(`CANCELED: Reason=${e.reason}`);
                    if (e.reason === SpeechSDK.CancellationReason.Error) {
                        if (DEV_MODE) console.error(`CANCELED: ErrorCode=${e.errorCode}`);
                        if (DEV_MODE) console.error(`CANCELED: ErrorDetails=${e.errorDetails}`);
                        if (DEV_MODE) console.error("CANCELED: Avez-vous mis √† jour la cl√© d'abonnement et la r√©gion ?");
                    }
                };

                recognizer.startContinuousRecognitionAsync();

                // intervalle de renouvellement du token Azure (9 minutes)
                tokenRefreshInterval = setInterval(async () => {
                    console.log("üîÑ Renouvellement du token Azure en cours...");
                    
                    const newData = await getTokenOrRefresh();
                    
                    if (newData && newData.token) {
                        // C'est la m√©thode magique : on met √† jour le token √† la vol√©e
                        recognizer.authorizationToken = newData.token;
                        console.log("Token renouvel√© avec succ√®s sans coupure !");
                    } else {
                        console.error("√âchec du renouvellement du token");
                    }
                    
                }, 9 * 60 * 1000); // 9 minutes * 60 secondes * 1000 ms

            } catch (error) {
                if (DEV_MODE) console.error("Erreur Critique de reconnaissance:", error.message);
                alert("Impossible de d√©marrer la reconnaissance");
                return;
            }
            
            document.getElementById('btnStart').disabled = true;
            document.getElementById('btnStop').disabled = false;

            console.log("reconnaissance d√©marr√©e");
        }

        function stopRecognition() {
            if (!recognizer) return;
            recognizer.stopContinuousRecognitionAsync();
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStop').disabled = true;

            if (tokenRefreshInterval) {
                clearInterval(tokenRefreshInterval);
                tokenRefreshInterval = null;
            }

            console.log("reconnaissance arr√™t√©e");
        }

        {% if DEV_MODE %}
        // --- Simulation flux traductions (format identique √† startRecognition) ---
        const DEV_SAMPLE_PHRASES = [
            { lang: "fr-FR", fr: "Bienvenue √† tous, nous commen√ßons la session.", es: "Bienvenidos a todos, comenzamos la sesi√≥n." },
            { lang: "fr-FR", fr: "Merci d'√™tre pr√©sents aujourd'hui.", es: "Gracias por estar presentes hoy." },
            { lang: "es-MX", fr: "Je vais maintenant r√©pondre √† vos questions.", es: "Voy a responder ahora a sus preguntas." },
            { lang: "fr-FR", fr: "Le budget pr√©vu sera discut√© en fin de r√©union.", es: "El presupuesto previsto se discutir√° al final de la reuni√≥n." },
            { lang: "es-MX", fr: "C'est un point important √† ne pas oublier.", es: "Es un punto importante que no hay que olvidar." },
            { lang: "fr-FR", fr: "Nous avons besoin de votre avis sur ce sujet.", es: "Necesitamos su opini√≥n sobre este tema." },
            { lang: "fr-FR", fr: "La prochaine √©tape est pr√©vue pour mardi.", es: "La pr√≥xima etapa est√° prevista para el martes." },
            { lang: "es-MX", fr: "Je r√©sume les d√©cisions prises.", es: "Resumo las decisiones tomadas." },
            { lang: "fr-FR", fr: "N'h√©sitez pas √† intervenir si vous avez des questions.", es: "No duden en intervenir si tienen preguntas." },
            { lang: "fr-FR", fr: "Le d√©lai de livraison est fix√© √† quinze jours.", es: "El plazo de entrega est√° fijado en quince d√≠as." },
            { lang: "es-MX", fr: "Nous allons examiner les propositions une par une.", es: "Vamos a examinar las propuestas una por una." },
            { lang: "fr-FR", fr: "Cela correspond exactement √† ce que nous voulions.", es: "Eso corresponde exactamente a lo que quer√≠amos." },
            { lang: "fr-FR", fr: "Je vous envoie le compte-rendu par email.", es: "Les env√≠o el acta por correo electr√≥nico." },
            { lang: "es-MX", fr: "La r√©union est ajourn√©e √† la semaine prochaine.", es: "La reuni√≥n queda aplazada para la pr√≥xima semana." },
            { lang: "fr-FR", fr: "Merci √† tous pour votre participation.", es: "Gracias a todos por su participaci√≥n." },
            { lang: "fr-FR", fr: "Nous devrions avoir une r√©ponse d'ici vendredi.", es: "Deber√≠amos tener una respuesta para el viernes." },
            { lang: "es-MX", fr: "C'est une excellente id√©e, √† creuser.", es: "Es una excelente idea, hay que desarrollarla." },
            { lang: "fr-FR", fr: "Le projet avance comme pr√©vu.", es: "El proyecto avanza seg√∫n lo previsto." },
            { lang: "fr-FR", fr: "Je vous propose qu'on fasse une pause de cinq minutes.", es: "Les propongo que hagamos una pausa de cinco minutos." },
            { lang: "es-MX", fr: "Tout le monde est d'accord sur ce point ?", es: "¬øTodo el mundo est√° de acuerdo en este punto?" },
        ];

        async function runDevTranslationFlood() {
            const btn = document.getElementById('btnDevFlood');
            if (btn) btn.disabled = true;
            const wordDelay = 90;
            const finalDelay = 600;
            for (const phrase of DEV_SAMPLE_PHRASES) {
                const frWords = phrase.fr.split(/\s+/);
                const esWords = phrase.es.split(/\s+/);
                const steps = Math.max(frWords.length, esWords.length, 1);
                for (let i = 0; i < steps; i++) {
                    const dataInterim = {
                        lang: phrase.lang,
                        fr: frWords.slice(0, i + 1).join(' '),
                        es: esWords.slice(0, i + 1).join(' '),
                        is_final: false,
                    };
                    if (DEV_MODE) console.log("emiting temp data:", dataInterim);
                    socket.emit('new_translation', dataInterim);
                    ui.addMessage(dataInterim);
                    await new Promise(r => setTimeout(r, wordDelay));
                }
                const dataFinal = {
                    lang: phrase.lang,
                    fr: phrase.fr,
                    es: phrase.es,
                    timestamp: new Date().toISOString(),
                    is_final: true,
                };
                if (DEV_MODE) console.log("emiting final data:", dataFinal);
                socket.emit('new_translation', dataFinal);
                ui.addMessage(dataFinal);
                await new Promise(r => setTimeout(r, finalDelay));
            }
            if (btn) btn.disabled = false;
        }
        {% endif %}

    </script>

</body>
</html>