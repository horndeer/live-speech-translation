<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Master - Traduction</title>
    <script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { background: #111; color: white; font-family: sans-serif; padding: 20px; }
        .controls { margin-bottom: 20px; padding: 10px; background: #222; border-radius: 8px;}
        button { padding: 10px 20px; font-size: 1.2em; cursor: pointer; }
        .status { color: #aaa; margin-left: 10px; }
        #live-preview { border-top: 1px solid #444; margin-top: 20px; padding-top: 10px; }
        .log-item { display: flex; gap: 20px; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .col { flex: 1; }
        .es { color: #ffbf00; } /* Jaune pour espagnol */
        .fr { color: #00bfff; } /* Bleu pour fran√ßais */
    </style>
</head>
<body>
    <div class="controls">
        <h2>üéõÔ∏è Contr√¥le Ma√Ætre</h2>
        <button id="btnStart" onclick="startRecognition()">‚ñ∂Ô∏è D√©marrer</button>
        <button id="btnStop" onclick="stopRecognition()" disabled>‚è∏Ô∏è Pause</button>
        <span id="status" class="status">Pr√™t</span>
    </div>

    <div id="live-preview">
        </div>

    <script>
        // R√©cup√©ration des cl√©s inject√©es par Python (s√©curis√© car rendu c√¥t√© serveur)
        const speechKey = "{{ speech_key }}";
        const serviceRegion = "{{ speech_region }}";

        const socket = io();
        let recognizer;

        // --- Configuration Azure ---
        function startRecognition() {
            const speechConfig = SpeechSDK.SpeechTranslationConfig.fromSubscription(speechKey, serviceRegion);
            
            // Configuration langues (Source auto: FR ou ES) -> Cibles: FR et ES
            // speechConfig.speechRecognitionLanguage = "fr-FR"; // Valeur par d√©faut
            
            // Astuce: AutoDetect en JS est un peu diff√©rent, pour simplifier 
            // on configure souvent une langue principale, ou on utilise AutoDetectSourceLanguageConfig
            // Pour ce script web JS, l'autodetect est plus complexe √† setup que le Python.
            // SIMPLIFICATION POUR LE TEST : On demande de traduire vers l'autre langue.
            // Si vous voulez l'autodetect strict comme en python, il faut un setup sp√©cifique.
            // Ici, je configure pour traduire FR -> ES et ES -> FR (Bidirectionnel simul√© via config)
            
            // √âtape A : On d√©finit une langue par d√©faut OBLIGATOIRE pour √©viter l'erreur "NullOrUndefined"
            // (Le SDK refuse de d√©marrer sans √ßa, m√™me si on veut de l'auto-detect)
            speechConfig.speechRecognitionLanguage = "fr-FR"; 

            // √âtape B : On configure les cibles
            speechConfig.addTargetLanguage("fr");
            speechConfig.addTargetLanguage("es");

            // √âtape C : On active l'autod√©tection via la "Property" interne
            // Cela va SURCHARGER la langue d√©finie √† l'√©tape A une fois la requ√™te envoy√©e √† Azure
            speechConfig.setProperty(
                SpeechSDK.PropertyId.SpeechServiceConnection_AutoDetectSourceLanguages, 
                "fr-FR,es-MX"
            );

            const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
            recognizer = new SpeechSDK.TranslationRecognizer(speechConfig, audioConfig);
            
            function getDetectedLanguage(result) {
                // On essaie de lire la propri√©t√© sp√©ciale renvoy√©e par Azure
                const autoDetectProp = result.properties.getProperty(SpeechSDK.PropertyId.SpeechServiceConnection_AutoDetectSourceLanguageResult);
                
                // Si Azure a trouv√©, on renvoie √ßa, sinon on renvoie la langue du r√©sultat standard
                return autoDetectProp || result.language || "fr-FR";
            }
            // --- √âv√©nements ---

            // 1. En cours de parole (Interim)
            recognizer.recognizing = (s, e) => {
                // On d√©tecte la langue
                let lang = getDetectedLanguage(e.result); // ex: fr-FR
                let text = e.result.text;
                let translations = e.result.translations;

                console.log("Langue d√©tect√©e:", lang);
                console.log("Texte:", text);
                console.log("Traductions:", translations);

                // Logique de filtrage (similaire au Python)
                let textFR = "", textES = "";
                
                if (lang.includes("fr")) {
                    textFR = text;
                    textES = translations.get("es");
                } else if (lang.includes("es")) {
                    textES = text;
                    textFR = translations.get("fr");
                }

                // Envoi au serveur (Mode temporaire)
                socket.emit('new_translation', {
                    fr: textFR,
                    es: textES,
                    is_final: false
                });
            };

            // 2. Phrase termin√©e (Final)
            recognizer.recognized = (s, e) => {
                if (e.result.reason == SpeechSDK.ResultReason.TranslatedSpeech) {
                    let lang = getDetectedLanguage(e.result);
                    let text = e.result.text;
                    let translations = e.result.translations;

                    console.log("Langue d√©tect√©e:", lang);
                    console.log("Texte:", text);
                    console.log("Traductions:", translations);

                    let textFR = "", textES = "";
                    if (lang.includes("fr")) {
                        textFR = text;
                        textES = translations.get("es");
                    } else if (lang.includes("es")) {
                        textES = text;
                        textFR = translations.get("fr");
                    }

                    // Envoi au serveur (Mode Final - Sera sauvegard√©)
                    socket.emit('new_translation', {
                        fr: textFR,
                        es: textES,
                        is_final: true
                    });
                }
            };

            recognizer.canceled = (s, e) => {
                console.error(`CANCELED: Reason=${e.reason}`);
                if (e.reason === SpeechSDK.CancellationReason.Error) {
                    console.error(`CANCELED: ErrorCode=${e.errorCode}`);
                    console.error(`CANCELED: ErrorDetails=${e.errorDetails}`);
                    console.error("CANCELED: Avez-vous mis √† jour la cl√© d'abonnement et la r√©gion ?");
                }
            };

            recognizer.startContinuousRecognitionAsync();
            
            document.getElementById('btnStart').disabled = true;
            document.getElementById('btnStop').disabled = false;
            document.getElementById('status').innerText = "üî¥ En direct - √âcoute...";

            console.log("D√©marrage de la reconnaissance...");
        }

        function stopRecognition() {
            recognizer.stopContinuousRecognitionAsync();
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStop').disabled = true;
            document.getElementById('status').innerText = "‚è∏Ô∏è Pause";

            console.log("Arr√™t de la reconnaissance...");
        }

        // --- R√©ception Socket (Pour voir ce que voient les autres) ---
        const container = document.getElementById('live-preview');

        
        
        socket.on('display_message', (data) => {
            // Si c'est un message final, on l'ajoute. 
            // Si c'est "en cours", on met √† jour une div temporaire (√† impl√©menter pour perfectionner)
            // Pour ce test simple, on affiche tout.
            
            // Nettoyage des messages "en cours" pr√©c√©dents si besoin
            let temp = document.getElementById('temp-msg');
            if(temp) temp.remove();

            if (data.is_final) {
                let div = document.createElement('div');
                div.className = 'log-item';
                div.innerHTML = `<div class="col fr">${data.fr}</div><div class="col es">${data.es}</div>`;
                container.prepend(div); // Les plus r√©cents en haut
            } else {
                let div = document.createElement('div');
                div.id = 'temp-msg';
                div.className = 'log-item';
                div.style.opacity = "0.7";
                div.innerHTML = `<div class="col fr">${data.fr}</div><div class="col es">${data.es}</div>`;
                container.prepend(div);
            }
        });
    </script>
</body>
</html>